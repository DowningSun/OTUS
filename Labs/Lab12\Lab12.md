## Лабораторная работа - Настройка NAT для IPv4

**Топология**

![image](https://github.com/DowningSun/OTUS/assets/156109695/57de33b8-737f-4d78-8f6e-b838919b3285)


Таблица адресации

| Устройство | Интерфейс | IP-адрес | Маска подсети |
| ------ | ------ | ------ | ------ |
| R2 | G0/0/0 | 209.165.200.230 | 255.255.255.248 |
|   | G0/0/1 | 192.168.1.1 | 255.255.255.0 |
| R2 | G0/0/0 | 209.165.200.225 | 255.255.255.248 |
|   | Lo1 | 209.165.200.1 | 255.255.255.224 |
| S1 | VLAN 1 | 192.168.1.11 | 255.255.255.0 |
| S2 | VLAN 1 | 192.168.1.12 | 255.255.255.0 |
| PC-A | NIC | 192.168.1.2 | 255.255.255.0 |
| PC-B | NIC | 192.168.1.3 | 255.255.255.0 |

**Ход работы**


**Часть 1. Создание сети и настройка основных параметров устройства**

**Шаг 1. Подключите кабели сети согласно приведенной топологии.**

**Шаг 2. Произведите базовую настройку маршрутизаторов.**

a. Назначьте маршрутизатору имя устройства.

b. Отключите поиск DNS, чтобы предотвратить попытки маршрутизатора неверно преобразовывать введенные команды таким образом, как будто они являются именами узлов.
                
c. Назначьте class в качестве зашифрованного пароля привилегированного режима EXEC.
                
d. Назначьте cisco в качестве пароля консоли и включите вход в систему по паролю.
                
e. Назначьте cisco в качестве пароля VTY и включите вход в систему по паролю.
                
f. Зашифруйте открытые пароли.
                
g. Создайте баннер с предупреждением о запрете несанкционированного доступа к устройству.
                
h. Настройте IP-адресации интерфейса, как указано в таблице выше.
                
i. Настройте маршрут по умолчанию. от R2 до  R1.
                
j. Сохраните текущую конфигурацию в файл загрузочной конфигурации.

**Шаг 3. Настройте базовые параметры каждого коммутатора.**

a. Присвойте коммутатору имя устройства.

b. Отключите поиск DNS, чтобы предотвратить попытки маршрутизатора неверно преобразовывать введенные команды таким образом, как будто они являются именами узлов.

c. Назначьте class в качестве зашифрованного пароля привилегированного режима EXEC.

d. Назначьте cisco в качестве пароля консоли и включите вход в систему по паролю.

e. Назначьте cisco в качестве пароля VTY и включите вход в систему по паролю.

f. Зашифруйте открытые пароли.

g. Создайте баннер с предупреждением о запрете несанкционированного доступа к устройству.

h. Выключите все интерфейсы, которые не будут использоваться.

i. Настройте IP-адресации интерфейса, как указано в таблице выше.

j. Сохраните текущую конфигурацию в файл загрузочной конфигурации.


**Часть 2. Настройка и проверка NAT для IPv4.**

**Шаг 1. Настройте NAT на R1, используя пул из трех адресов 209.165.200.226-209.165.200.228.** 


a. Настройте простой список доступа, который определяет, какие хосты будут разрешены для трансляции. В этом случае все устройства в локальной сети R1 имеют право на трансляцию.

R1(config)# access-list 1 permit 192.168.1.0 0.0.0.255 

b. Создайте пул NAT и укажите ему имя и диапазон используемых адресов.

R1(config)# ip nat pool PUBLIC_ACCESS 209.165.200.226 209.165.200.228 netmask 255.255.255.248 

Примечание. Параметр маски сети не является разделителем IP-адресов. Это должна быть правильная маска подсети для назначенных адресов, даже если вы используете не все адреса подсети в пуле. 

c. Настройте перевод, связывая ACL и пул с процессом преобразования.

R1(config)# ip nat inside source list 1 pool PUBLIC_ACCESS 

Примечание: Три очень важных момента. Во-первых, слово «inside» имеет решающее значение для работы такого рода NAT. Если вы опустить его, NAT не будет работать. Во-вторых, номер списка — это номер ACL, настроенный на предыдущем шаге. В-третьих, имя пула чувствительно к регистру. 

d. Задайте внутренний (inside) интерфейс. 

R1(config)# interface g0/0/1

R1(config-if)# ip nat inside

e. Определите внешний (outside) интерфейс.

R1(config)# interface g0/0/0

R1(config-if)# ip nat outside

Шаг 2. Проверьте и проверьте конфигурацию. 

a. С PC-B,  запустите эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните процес поиска и устранения неполадок. На R1 отобразите таблицу NAT на R1 с помощью команды show ip nat translations.

R1# show ip nat translations

Pro Inside global Inside local Outside local Outside global

--- 209.165.200.226 192.168.1.3 --- --- 
226:1 192.168.1. 3:1 209.165.200. 1:1 209.165.200. 1:1 


**Вопросы:**

**Во что был транслирован внутренний локальный адрес PC-B?**

![image](https://github.com/DowningSun/OTUS/assets/156109695/241c21c1-97aa-4a48-a567-55d2cf0b90c6)

В outsite global 209.165.200.227
 
**Какой тип адреса NAT является переведенным адресом?**

Роутер добавляет сопоставление локального в глобальный адрес в таблицу NAT и отправляет пакет с переведенным адресом источника в пункт назначения. Т.о. переведенный - внутренний локальный адрес в момент, после перевода его во внутренний глобальный адерс.


b. С PC-A, запустите  эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды show ip nat translations.

R1# show ip nat translations 

Pro Inside global Inside local Outside local Outside global
--- 209.165.200.227 192.168.1.2 --- ---
--- 209.165.200.226 192.168.1.3 --- ---
227:1 192.168.1. 2:1 209.165.200. 1:1 209.165.200. 1:1
226:1 192.168.1. 3:1 209.165.200. 1:1 209.165.200. 1:1
Total number of translations: 4

![image](https://github.com/DowningSun/OTUS/assets/156109695/14917e23-ffd7-4ace-b12f-68f8c3e467d3)

c. Обратите внимание, что предыдущая трансляция для PC-B все еще находится в таблице. Из S1, эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды show ip nat translations.

R1# show ip nat translations
Pro Inside global Inside local Outside local Outside global
--- 209.165.200.227 192.168.1.2 --- ---
--- 209.165.200.226 192.168.1.3 --- ---
--- 209.165.200.228 192.168.1.11 --- ---
226:1 192.168.1. 3:1 209.165.200. 1:1 209.165.200. 1:1
228:0 192.168.1. 11:0 209.165.200. 1:0 209.165.200. 1:0 209.165.200. 1:0
Total number of translations: 5

d. Теперь запускаем пинг R2 Lo1 из S2. На этот раз перевод завершается неудачей, и вы получаете эти сообщения (или аналогичные) на консоли R1:

Sep 23 15:43:55.562: %IOSXE-6-PLATFORM: R0/0: cpp_cp: QFP:0.0 Thread:000 TS:00000001473688385900 %NAT-6-ADDR_ALLOC_FAILURE: Address allocation failed; pool 1 may be exhausted [2]

e. Это ожидаемый результат, потому что выделено только 3 адреса, и мы попытались ping Lo1 с четырех устройств. Напомним, что NAT — это трансляция «один-в-один». Как много выделено трансляций? Введите команду show ip nat translations verbose , и вы увидите, что ответ будет 24 часа.

R1# show ip nat translations verbose 

Pro Inside global Inside local Outside local Outside global

--- 209.165.200.226 192.168.1.3 --- ---
  create: 09/23/19 15:35:27, use: 09/23/19 15:35:27, timeout: 23:56:42
  Map-Id(In): 1
<output omitted>

f. Учитывая, что пул ограничен тремя адресами, NAT для пула адресов недостаточно для нашего приложения. Очистите преобразование NAT и статистику, и мы перейдем к PAT.

R1# clear ip nat translations * 
R1# clear ip nat statistics 

**Часть 3. Настройка и проверка PAT для IPv4.**


**Шаг 1. Удалите команду преобразования на R1.**

R1(config)# no ip nat inside source list 1 pool PUBLIC_ACC

**Шаг 2. Добавьте команду PAT на R1.**

R1(config)# ip nat inside source list 1 pool PUBLIC_ACCESS overload 
            
**Шаг 3. Протестируйте и проверьте конфигурацию.**
                
a. Давайте проверим, что PAT работает. С PC-B,  запустите эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды show ip nat translations.

![image](https://github.com/DowningSun/OTUS/assets/156109695/20cba4f4-3735-47b4-8de8-4eaa82006a11)

**Вопросы:**

**Во что был транслирован внутренний локальный адрес PC-B?**

В outsite global 209.165.200.228
 
**Какой тип адреса NAT является переведенным адресом?**

переведенный - внутренний локальный адрес в момент, после перевода его во внутренний глобальный адерс.

**Чем отличаются выходные данные команды show ip nat translations из упражнения NAT?**

![image](https://github.com/DowningSun/OTUS/assets/156109695/38c7194e-d220-4fea-aabf-b1b932539883)

Они идентичны.

b. С PC-A, запустите эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды show ip nat translations.

![image](https://github.com/DowningSun/OTUS/assets/156109695/a7f90d77-65f9-4f6d-840f-d38a756cf61f)

Обратите внимание, что есть только одна трансляция. Отправьте ping еще раз, и быстро вернитесь к маршрутизатору и введите команду show ip nat translations verbose , и вы увидите, что произошло.
R1# show ip nat translations verbose 
Pro Inside global Inside local Outside local Outside global
icmp 209.165.200.226:1 192.168.1.2:1 209.165.200.1:1 209.165.200.1:1 
  create: 09/23/19 16:57:22, use: 09/23/19 16:57:25, timeout: 00:01:00
<output omitted>
Как вы можете видеть, время ожидания перевода было отменено с 24 часов до 1 минуты.

![image](https://github.com/DowningSun/OTUS/assets/156109695/64238809-da8b-495b-89cf-f0a6e6a6afa1)

не можем

c. Генерирует трафик с нескольких устройств для наблюдения PAT. На PC-A и PC-B используйте параметр -t с командой ping, чтобы отправить безостановочный ping на интерфейс Lo1 R2 (ping -t 209.165.200.1), затем вернитесь к R1 и выполните команду show ip nat translations:

![image](https://github.com/DowningSun/OTUS/assets/156109695/33cbcca4-ee57-4025-a449-4580fd599bf3)

Обратите внимание, что внутренний глобальный адрес одинаков для обоих сеансов. 

**Вопрос:**

**Как маршрутизатор отслеживает, куда идут ответы?**

PAT пытается сохранить поурт источника, если порт уже занят, то система назначает другой порт. Т.о. формируется связь порт-источник, по которой и происходит отслеживание и перенаправления ответов.
 
d. PAT в пул является очень эффективным решением для малых и средних организаций. Тем не менее есть неиспользуемые адреса IPv4, задействованные в этом сценарии. Мы перейдем к PAT с перегрузкой интерфейса, чтобы устранить эту трату IPv4 адресов. Остановите ping на PC-A и PC-B с помощью комбинации клавиш Control-C, затем очистите трансляции и статистику:

R1# clear ip nat translations * 
R1# clear ip nat statistics 

**Шаг 4. На R1 удалите команды преобразования nat pool.**

R1(config)# no ip nat inside source list 1 pool PUBLIC_ACC overload 
R1(config)# no ip nat pool PUBLIC_ACC

**Шаг 5. Добавьте команду PAT overload, указав внешний интерфейс.**

R1(config)# ip nat inside source list 1 interface g0/0/0 overload 

**Шаг 6. Протестируйте и проверьте конфигурацию.**

a. Давайте проверим PAT, чтобы интерфейс работал. С PC-B,  запустите эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды show ip nat translations.

![image](https://github.com/DowningSun/OTUS/assets/156109695/9e5f4ced-67d4-4624-9bbf-61b6d4333793)

b. Сделайте трафик с нескольких устройств для наблюдения PAT. На PC-A и PC-B используйте параметр -t с командой ping для отправки безостановочного ping на интерфейс Lo1 R2 (ping -t 209.165.200.1). На S1 и S2 выполните привилегированную команду exec ping 209.165.200.1 повторить 2000. Затем вернитесь к R1 и выполните команду show ip nat translations.

![image](https://github.com/DowningSun/OTUS/assets/156109695/e049148d-acbc-44e8-bee3-caf6f671bb4c)

**Теперь все внутренние глобальные адреса сопоставляются с IP-адресом интерфейса g0/0/0.**

## Часть 4. Настройка и проверка статического NAT для IPv4.

**Шаг 1. На R1 очистите текущие трансляции и статистику.**

R1# clear ip nat translations * 
R1# clear ip nat statistics 

**Шаг 2. На R1 настройте команду NAT, необходимую для статического сопоставления внутреннего адреса с внешним адресом.**

R1(config)# ip nat inside source static 192.168.1.2 209.165.200.229 

**Шаг 3. Протестируйте и проверьте конфигурацию.**


a. Давайте проверим, что статический NAT работает. На R1 отобразите таблицу NAT на R1 с помощью команды show ip nat translations, и вы увидите статическое сопоставление.

R1# show ip nat translations

![image](https://github.com/DowningSun/OTUS/assets/156109695/f0eb2bf1-0039-453b-bdd7-ebbf51baef05)

b. Таблица перевода показывает, что статическое преобразование действует. Проверьте это, запустив ping  с R2 на 209.165.200.229. Плинги должны работать.

![image](https://github.com/DowningSun/OTUS/assets/156109695/9e0cbcfc-96b1-4b4c-9f25-72036e4f8dc7)


c. На R1 отобразите таблицу NAT на R1 с помощью команды show ip nat translations, и вы увидите статическое сопоставление и преобразование на уровне порта для входящих pings.

![image](https://github.com/DowningSun/OTUS/assets/156109695/ff234aab-a93d-4b75-b6fd-81567aea3fd9)

Это подтверждает, что статический NAT работает.
